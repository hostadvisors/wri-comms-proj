---
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
import { Card } from '@astrojs/starlight/components';

const PROTECTED_PASSWORD = import.meta.env.PLAYBOOK_PASSWORD;

// Get URL parameters and form data
const url = Astro.url;
const error = url.searchParams.get('error');
let returnTo = url.searchParams.get('returnTo') || '/foundation/overview/';

let password = null;
// Handle both GET (from URL params) and POST (from form data)
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  password = formData.get('password')?.toString();
  // Get returnTo from form data if available
  const formReturnTo = formData.get('returnTo')?.toString();
  if (formReturnTo) {
    returnTo = formReturnTo;
  }
} else if (Astro.request.method === 'GET') {
  password = url.searchParams.get('password');
}

// Handle form submission
if ((Astro.request.method === 'POST' || Astro.request.method === 'GET') && password) {
  if (password === PROTECTED_PASSWORD) {
    // Set authentication cookie for 24 hours
    Astro.cookies.set('wri-auth', 'authenticated', {
      maxAge: 24 * 60 * 60, // 24 hours
      httpOnly: true,
      secure: import.meta.env.PROD,
      sameSite: 'strict',
      path: '/' // Ensure cookie is available site-wide
    });
    
    // Use relative redirect to avoid production URL issues
    const redirectPath = returnTo || '/foundation/overview/';
    return new Response('', {
      status: 302,
      headers: {
        'Location': redirectPath
      }
    });
  } else {
    // Invalid password - redirect back with error
    return new Response('', {
      status: 302,
      headers: {
        'Location': `/login?error=invalid&returnTo=${encodeURIComponent(returnTo)}`
      }
    });
  }
}
---

<StarlightPage frontmatter={{
  title: "Access Required",
  description: "Login to access the WRI Internal Communications Playbook",
  template: "splash"
}}>
  <div style="max-width: 500px; margin: 0 auto;">
    
    <Card title="Access Required" icon="seti:lock">
      <p>This playbook is for <strong>WRI team members only</strong>. Please enter the access code to continue.</p>
      
      {error === 'invalid' && (
        <div style="color: var(--sl-color-red); margin-bottom: 1rem; padding: 0.75rem; background: var(--sl-color-red-low); border-radius: 6px; font-size: 0.9rem;">
          <strong>Invalid access code.</strong> Please try again.
        </div>
      )}
      
      <form method="post" action="/login" style="margin-top: 1.5rem;">
        <input type="hidden" name="returnTo" value={returnTo} />
        <div style="margin-bottom: 1rem;">
          <label for="password" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
            Access Code:
          </label>
          <input 
            type="password" 
            id="password" 
            name="password" 
            required
            autofocus
            style="
              width: 100%; 
              padding: 0.75rem; 
              border: 1px solid var(--sl-color-hairline); 
              border-radius: 6px; 
              background: var(--sl-color-bg);
              color: var(--sl-color-text);
              font-size: 1rem;
            "
            placeholder="Enter access code"
          />
        </div>
        <button 
          type="submit"
          style="
            background: var(--wri-gold-bg); 
            color: white; 
            border: none; 
            padding: 0.75rem 1.5rem; 
            border-radius: 6px; 
            font-weight: 700; 
            cursor: pointer; 
            width: 100%;
            font-size: 1rem;
          "
        >
          Access Playbook
        </button>
      </form>
      
      <div style="margin-top: 1.5rem; padding: 1rem; background: var(--sl-color-bg-sidebar); border-radius: 8px; font-size: 0.9rem;">
        <strong>Need access?</strong><br/>
        Contact the Internal Communications team at <a href="mailto:internal-comms@wri.org">internal-comms@wri.org</a>
      </div>
    </Card>
    
    <div style="margin-top: 2rem; text-align: center;">
      <a href="/" style="color: var(--sl-color-text-accent); text-decoration: none;">
        ‚Üê Back to Homepage
      </a>
    </div>
    
  </div>
</StarlightPage>
